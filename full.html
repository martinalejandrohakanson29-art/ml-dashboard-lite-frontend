<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MercadoLibre Full — Módulos</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--line:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);min-height:100vh}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid var(--line);border-radius:14px;padding:14px 16px;box-shadow:0 8px 22px rgba(0,0,0,.25);margin-bottom:14px}
    h1{margin:0 0 10px 0;font-size:1.1rem}
    label{display:block;font-size:.9rem;margin:8px 0 4px;color:var(--muted)}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #263043;background:#0f172a;color:var(--text)}
    .row{display:grid;grid-template-columns:1fr 220px;gap:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;text-decoration:none;
      color:#0b122a;background:#f8fafc;border:1px solid #e5e7eb;font-weight:700;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .muted{color:var(--muted);font-size:.9rem}
    table{width:100%;border-collapse:collapse;border-spacing:0;font-size:.92rem}
    th, td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{font-weight:700}
    .status{margin-left:8px;font-size:.9rem}
    .error{color:#fca5a5}.ok{color:#86efac}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .back{font-size:.9rem}
    /* título ancho en una línea */
    .col-title{ white-space:nowrap; width:60%; min-width:520px }
    /* tabs submódulos */
    .subnav{display:flex;gap:8px;margin:8px 0 14px}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0f172a;color:var(--text);cursor:pointer}
    .tab.active{background:#1f2937}
    .hidden{display:none}
    .card + .card { margin-top: 14px; }
    .link{font-size:.9rem; text-decoration:underline; color:#cbd5e1; cursor:pointer}
    .fullbleed {
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
  border-left: 0;
  border-right: 0;
  border-radius: 0;
}
.fullbleed table { width: 100%; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back btn" href="index.html">← Volver</a>
      <div class="muted">Módulo: MercadoLibre Full</div>
    </div>

    <!-- Config -->
    <section class="card">
      <h1>Config</h1>
      <div class="row">
        <div>
          <label>API Base URL (tu backend en Render)</label>
          <input id="apiUrl" placeholder="https://tu-backend.onrender.com" />
        </div>
        <div>
          <label>Token (Bearer = API_SECRET)</label>
          <input id="apiToken" placeholder="pegá el API_SECRET" />
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap">
        <button class="btn" id="btnSave">Guardar</button>
        <button class="btn" id="btnProbe">Probar conexión</button>
        <a id="openHealth" class="link" target="_blank" rel="noopener">Abrir /health</a>
        <span id="probeMsg" class="status muted"></span>
      </div>
    </section>

    <!-- SUBNAV -->
    <section class="subnav">
      <button class="tab active" data-view="stock">Stock</button>
      <button class="tab" data-view="shipments">Envíos FULL</button>
    </section>

    <!-- ===== Submódulo: STOCK ===== -->
    <div id="view-stock">
      <!-- Acciones — Stock -->
      <section class="card">
        <h1>Acciones — Stock</h1>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <button class="btn" id="btnLoad">Cargar stock FULL</button>
          <input id="q" placeholder="Buscar en todas las columnas..."
                 style="flex:1; min-width:220px; padding:10px 12px; border-radius:10px;
                        border:1px solid #263043; background:#0f172a; color:var(--text)" />
          <span id="loadMsg" class="status muted"></span>
        </div>
      </section>

      <!-- Acciones — KPIs 30d -->
      <section class="card">
        <h1>Acciones — KPIs 30d</h1>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <button class="btn" id="btnLoadKpis">Cargar KPIs 30d</button>
          <span id="loadMsgKpis" class="status muted"></span>
        </div>
      </section>

      <!-- Tabla KPIs -->
     <section class="card fullbleed">
  <h1>Tabla: KPIs 30d (stock + visitas + ventas)</h1>
  <div id="kpisWrap" class="muted">Sin datos aún.</div>
</section>


      <!-- Tabla Stock -->
      <section class="card">
        <h1>Tabla: full_stock_min</h1>
        <div id="tableWrap" class="muted">Sin datos aún.</div>
      </section>
    </div>

    <!-- ===== Submódulo: ENVÍOS FULL (placeholder) ===== -->
    <div id="view-shipments" class="hidden">
      <section class="card">
        <h1>Acciones — Envíos FULL</h1>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <button class="btn" disabled title="Próximamente">Cargar envíos (próximamente)</button>
          <span class="status muted">En esta vista vamos a listar envíos FULL (etiquetas, tracking, etc.).</span>
        </div>
      </section>
      <section class="card">
        <h1>Tabla: envíos FULL</h1>
        <div id="shipmentsWrap" class="muted">Próximamente.</div>
      </section>
    </div>
  </div>

  <script>
    const $ = (q) => document.querySelector(q);
    const LS_KEY = 'ml_full_cfg';

    // ===== Tabs =====
    function setView(view){
      document.querySelectorAll('.tab').forEach(b=>{
        b.classList.toggle('active', b.dataset.view === view);
      });
      $('#view-stock').classList.toggle('hidden', view !== 'stock');
      $('#view-shipments').classList.toggle('hidden', view !== 'shipments');
    }
    document.querySelectorAll('.tab').forEach(b=>{
      b.addEventListener('click', ()=> setView(b.dataset.view));
    });

    // ===== Helpers config =====
    function getCfg(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); } catch(_){ return {}; } }
    function setCfg(cfg){ localStorage.setItem(LS_KEY, JSON.stringify(cfg)); }
    function readInputs(){ return { url: $('#apiUrl').value.trim(), token: $('#apiToken').value.trim() }; }
    function writeInputs(cfg){ $('#apiUrl').value = cfg.url || ''; $('#apiToken').value = cfg.token || ''; updateHealthLink(); }

    function normalizeUrl(raw){
      let url = (raw || '').trim();
      if (!url) return '';
      // Si viene con http, lo forzamos a https (los navegadores bloquean "http" desde un sitio https)
      if (/^http:\/\//i.test(url)) url = url.replace(/^http:\/\//i, 'https://');
      return url.replace(/\/+$/,''); // sin barra final
    }

    function updateHealthLink(){
      const { url } = getCfg();
      const base = normalizeUrl(url);
      const a = $('#openHealth');
      if (base) {
        a.href = base + '/health';
        a.style.pointerEvents = 'auto';
        a.style.opacity = 1;
      } else {
        a.removeAttribute('href');
        a.style.pointerEvents = 'none';
        a.style.opacity = .6;
      }
    }

    async function apiFetch(path){
      const raw = getCfg();
      const base = normalizeUrl(raw.url);
      const token = raw.token || '';
      if(!base) throw new Error('Falta API Base URL');
      if(!/^https:\/\//i.test(base)) throw new Error('La URL debe usar https');

      const res = await fetch(base + path, {
        mode: 'cors',
        headers: { 'Authorization': token ? `Bearer ${token}` : '' }
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok || data.ok === false){
        throw new Error(data.error || `HTTP ${res.status}`);
      }
      return data;
    }

    // ===== Buscador / filtro (stock y kpis) =====
    let fullRows = [];
    let kpiRows  = [];
    const hiddenCols = ['available_quantity','created_date_utc','created_at','updated_at'];

    function getQuery(){ const el = $('#q'); return el ? el.value.trim().toLowerCase() : ''; }
    function filterRows(rows){
      const q = getQuery(); if(!q) return rows;
      return rows.filter(obj =>
        Object.entries(obj).some(([k, v]) => {
          if (hiddenCols.includes(k)) return false;
          if (v == null) return false;
          return String(v).toLowerCase().includes(q);
        })
      );
    }

    // ===== Tablas =====
    function renderTable(rows){
      const wrap = $('#tableWrap');
      if(!rows || !rows.length){ wrap.innerHTML = '<span class="muted">Sin filas.</span>'; return; }
      const hidden = new Set(['available_quantity','created_date_utc','created_at','updated_at']);
      const rename = { not_available_quantity: 'pausados' };
      const all = Object.keys(rows[0]).filter(c => !hidden.has(c));
      const preferred = ['title','total','not_available_quantity'];
      const rest = all.filter(c => !preferred.includes(c));
      const cols = [...preferred.filter(c => all.includes(c)), ...rest];

      let html = '<div style="overflow:auto"><table><thead><tr>';
      html += cols.map(c => {
        const cls = (c === 'title') ? ' class="col-title"' : '';
        const label = rename[c] || c;
        return `<th${cls}>${label}</th>`;
      }).join('');
      html += '</tr></thead><tbody>';

      for(const r of rows){
        html += '<tr>' + cols.map(c => {
          const cls = (c === 'title') ? ' class="col-title"' : '';
          return `<td${cls}>${safe(r[c])}</td>`;
        }).join('') + '</tr>';
      }
      html += '</tbody></table></div>';
      wrap.innerHTML = html;
    }

     function renderKpisTable(rows){
    const wrap = $('#kpisWrap');
    if(!rows || !rows.length){
      wrap.innerHTML = '<span class="muted">Sin filas.</span>';
      return;
    }

    // Ocultamos metadatos y "pausados" (not_available_quantity)
    const hidden = new Set(['created_at','updated_at','available_quantity','not_available_quantity']);

    // Renombres (ya SIN "pausados")
    const rename = {
      visits_30d: 'visitas 30d',
      orders_30d: 'ventas 30d',
      conversion_30d: 'conversión',
      orders_per_day_30d: 'prom. diario',
      visits_per_day_30d: 'visits prom diario'
    };

    const all = Object.keys(rows[0]).filter(c => !hidden.has(c));
    const preferred = [
      'title','visits_30d','orders_30d','conversion_30d',
      'orders_per_day_30d','visits_per_day_30d','total',
      'inventory_id','item_id'
    ];
    const rest = all.filter(c => !preferred.includes(c));
    const cols = [...preferred.filter(c => all.includes(c)), ...rest];

    let html = '<div style="overflow:auto"><table><thead><tr>';
    html += cols.map(c => {
      const cls = (c === 'title') ? ' class="col-title"' : '';
      const label = rename[c] || c;
      return `<th${cls}>${label}</th>`;
    }).join('');
    html += '</tr></thead><tbody>';

    for(const r of rows){
      html += '<tr>' + cols.map(c => {
        const cls = (c === 'title') ? ' class="col-title"' : '';
        let val = r[c];

        // Conversión en % (dos decimales)
        if (c === 'conversion_30d' && val != null) {
          const num = Number(val) * 100;
          val = isFinite(num) ? `${num.toFixed(2)}%` : '';
        }
        // Promedios con 3 decimales
        if ((c === 'orders_per_day_30d' || c === 'visits_per_day_30d') && val != null) {
          const num = Number(val);
          val = isFinite(num) ? num.toFixed(3) : '';
        }

        return `<td${cls}>${safe(val)}</td>`;
      }).join('') + '</tr>';
    }
    html += '</tbody></table></div>';
    wrap.innerHTML = html;
  }

    function safe(v){ if(v==null) return ''; if(typeof v === 'object') return JSON.stringify(v); return String(v); }

    // ===== Eventos =====
    $('#btnSave').addEventListener('click', ()=>{
      const cfg = readInputs(); setCfg(cfg); writeInputs(cfg);
      $('#probeMsg').textContent = 'Guardado.'; $('#probeMsg').className = 'status ok';
      setTimeout(()=>{ $('#probeMsg').textContent=''; $('#probeMsg').className='status muted'; }, 1200);
    });

    $('#btnProbe').addEventListener('click', async ()=>{
      const cfg = readInputs(); setCfg(cfg); writeInputs(cfg);
      $('#probeMsg').textContent = 'Probando...'; $('#probeMsg').className = 'status';
      try{
        const base = normalizeUrl(getCfg().url);
        if(!/^https:\/\//i.test(base)) throw new Error('La URL debe usar https');
        const h = await apiFetch('/health'); 
        const e = await apiFetch('/env-check');
        $('#probeMsg').textContent = `OK (uptime ${h.uptime_s}s, env: ${e.hasUrl?'URL':'-'} ${e.hasServiceRole?'SR':'-'} ${e.hasApiSecret?'TOK':'-'})`;
        $('#probeMsg').className = 'status ok';
      }catch(err){
        $('#probeMsg').textContent = 'Error: ' + err.message + ' (revisá que la URL empiece con https y sea la pública de Render)';
        $('#probeMsg').className = 'status error';
      }
    });

    const qEl = $('#q');
    if(qEl){ qEl.addEventListener('input', ()=>{
      renderTable(filterRows(fullRows));
      renderKpisTable(filterRows(kpiRows));
    });}

    const btnLoad = $('#btnLoad');
    if(btnLoad){
      btnLoad.addEventListener('click', async ()=>{
        $('#loadMsg').textContent = 'Cargando...'; $('#loadMsg').className = 'status';
        try{
          const data = await apiFetch('/full/stock');
          fullRows = data.rows || [];
          renderTable(filterRows(fullRows));
          $('#loadMsg').textContent = `Filas: ${fullRows.length}`; $('#loadMsg').className = 'status ok';
        }catch(err){
          $('#loadMsg').textContent = 'Error: ' + err.message; $('#loadMsg').className = 'status error';
        }
      });
    }

    const btnLoadKpis = $('#btnLoadKpis');
    if(btnLoadKpis){
      btnLoadKpis.addEventListener('click', async ()=>{
        $('#loadMsgKpis').textContent = 'Cargando...'; $('#loadMsgKpis').className = 'status';
        try{
          const data = await apiFetch('/full/kpis-30d');
          kpiRows = data.rows || [];
          renderKpisTable(filterRows(kpiRows));
          $('#loadMsgKpis').textContent = `Filas: ${kpiRows.length}`; $('#loadMsgKpis').className = 'status ok';
        }catch(err){
          $('#loadMsgKpis').textContent = 'Error: ' + err.message; $('#loadMsgKpis').className = 'status error';
        }
      });
    }

    // init
    writeInputs(getCfg());
    setView('stock');
  </script>
</body>
</html>
