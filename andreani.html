<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Previsualizaci√≥n y env√≠o a planilla (Andreani)</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --panel:#0b1224;     /* slightly darker */
      --text:#e5e7eb;      /* gray-200 */
      --muted:#94a3b8;     /* slate-400 */
      --ok:#16a34a;        /* green-600 */
      --warn:#d97706;      /* amber-600 */
      --bad:#b91c1c;       /* red-700 */
      --chip:#111827;      /* gray-900 */
      --brand:#2563eb;     /* blue-600 */
      --brand2:#60a5fa;    /* blue-300 */
      --card:#111827;      /* gray-900 */
      --input:#0b1224;
      --border:#1f2937;    /* gray-800 */
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}
    h1{font-size:22px; margin:0 0 16px;}
    h2{font-size:18px; margin:24px 0 12px;}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:12px; padding:16px; margin-bottom:16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .grid{display:grid; gap:12px}
    .grid.cols-4{grid-template-columns: repeat(4, minmax(0,1fr));}
    .grid.cols-2{grid-template-columns: repeat(2, minmax(0,1fr));}
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="number"]{
      background:var(--input); color:var(--text);
      border:1px solid var(--border); border-radius:10px;
      padding:10px 12px; outline:none; font-size:14px;
    }
    input[readonly]{opacity:.9}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      border:1px solid var(--border); background:var(--brand);
      color:white; padding:10px 14px; border-radius:10px;
      font-weight:600; cursor:pointer;
      transition: transform .05s ease, background .2s ease;
    }
    .btn:hover{background:var(--brand2); color:#0b1224}
    .btn:active{transform:scale(.98)}
    .btn.ghost{background:transparent; color:var(--text)}
    .btn.badge{position:relative}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .chip{
      display:inline-flex; align-items:center; padding:8px 12px;
      border-radius:999px; font-weight:700; font-size:12px;
      background:#0f172a; border:1px solid var(--border);
    }
    .chip.ok{background:rgba(22,163,74,.12); border-color:rgba(22,163,74,.35); color:#86efac}
    .chip.warn{background:rgba(217,119,6,.12); border-color:rgba(217,119,6,.35); color:#fcd34d}
    .chip.bad{background:rgba(185,28,28,.12); border-color:rgba(185,28,28,.35); color:#fecaca}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px; white-space:pre-wrap; background:#0b1224; border:1px solid var(--border);
      border-radius:10px; padding:12px; color:#cbd5e1;
    }
    .footer{opacity:.7; font-size:12px; margin-top:16px}
    @media (max-width:900px){.grid.cols-4{grid-template-columns: repeat(2, minmax(0,1fr));}}
    @media (max-width:640px){.grid.cols-4,.grid.cols-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Previsualizaci√≥n</h1>

    <div class="card">
      <div class="grid cols-4">
        <div class="field">
          <label>Peso (grs)</label>
          <input id="peso_grs" type="number" readonly />
        </div>
        <div class="field">
          <label>Alto (cm)</label>
          <input id="alto_cm" type="number" readonly />
        </div>
        <div class="field">
          <label>Ancho (cm)</label>
          <input id="ancho_cm" type="number" readonly />
        </div>
        <div class="field">
          <label>Valor declarado ($)</label>
          <input id="valor_declarado" type="number" readonly />
        </div>
      </div>

      <div id="alerts" class="chips" aria-live="polite"></div>
    </div>

    <div class="card">
      <h2>Acciones</h2>
      <div class="row">
        <button id="btnAI" class="btn">Procesar con IA</button>
        <button id="btnConfirm" class="btn">Confirmar y agregar a hoja</button>
        <button id="btnCopy" class="btn ghost">Copiar JSON</button>
      </div>
      <div class="footer">Si algo falla, prob√° ‚ÄúProcesar con IA‚Äù nuevamente.</div>
    </div>

    <div class="card">
      <h2>Salida del workflow</h2>
      <div id="jsonOut" class="mono">{}</div>
    </div>
  </div>

  <script>
    // üëâüëâ Configur√° tu endpoint de n8n ac√°
    const WORKFLOW_URL = 'REEMPLAZAR_AQUI_CON_TU_WEBHOOK_O_ENDPOINT';

    // ----------------- utilidades -----------------
    const $ = (id) => document.getElementById(id);
    const alerts = $('alerts');
    const out = $('jsonOut');

    const safeStr = (v) => (v === undefined || v === null) ? '' : String(v);
    const hasVal = (v) => safeStr(v).trim() !== '';

    // ----------------- render helpers -----------------
    function renderPreview(d){
      $('peso_grs').value = d.peso_grs ?? 1000;
      $('alto_cm').value = d.alto_cm ?? 10;
      $('ancho_cm').value = d.ancho_cm ?? 10;
      $('valor_declarado').value = d.valor_declarado ?? 50000;
    }

    function renderAlerts(missing, warns, extras){
      alerts.innerHTML = '';
      (warns||[]).forEach(w => {
        const s = document.createElement('span');
        s.className = 'chip warn';
        s.textContent = w;
        alerts.appendChild(s);
      });
      (missing||[]).forEach(m => {
        const s = document.createElement('span');
        s.className = 'chip bad';
        s.textContent = m;
        alerts.appendChild(s);
      });

      // Si viene un mensaje de tel√©fono y el estado NO es OK, mostramos el aviso
      if (extras && extras.telefono_msg && String(extras.telefono_estado || '').toUpperCase() !== 'OK') {
        const s = document.createElement('span');
        s.className = 'chip warn';
        s.textContent = extras.telefono_msg;
        alerts.appendChild(s);
      }
    }

    // ----------------- normalizaci√≥n / payload -----------------
    function toFinalPayload(d){
      const src = { ...d };

      // Backwards-compat: si vienen campos celulares, los usamos como tel√©fono
      if (!src.tel_codigo && src.cel_codigo) src.tel_codigo = src.cel_codigo;
      if (!src.tel_numero && src.cel_numero) src.tel_numero = src.cel_numero;

      // Normalizamos por si vinieron num√©ricos
      src.tel_codigo = safeStr(src.tel_codigo).trim();
      src.tel_numero = safeStr(src.tel_numero).trim();

      // Whitelist ‚Üí s√≥lo mandamos lo que necesitamos
      const keep = [
        'peso_grs','alto_cm','ancho_cm','profundidad_cm','valor_declarado',
        'nombre','apellido','dni','email','tel_codigo','tel_numero',
        'calle','numero','depto','ciudad','partido_o_localidad','provincia','cp','referencias',
        'telefono_estado','telefono_msg' // ‚Üê agregado
      ];
      const out = {};
      keep.forEach(k => { if (k in src) out[k] = src[k]; });
      return out;
    }

    function getMissing(finalD){
      const miss = [];
      const warns = [];

      // Altura 0 -> warning (no bloquea)
      const numeroStr = safeStr(finalD.numero).trim();
      if (!hasVal(numeroStr)) miss.push('Falta altura de calle');
      else if (numeroStr === '0') warns.push('Altura no provista (se usa 0)');

      // Email simple
      const email = safeStr(finalD.email);
      if (!/.+@.+\..+/.test(email)) miss.push('Email faltante o inv√°lido');

      // Tel√©fono: si estado OK, consideramos v√°lido aunque falte formateo
      const telEstadoOk = String(finalD.telefono_estado || '').toUpperCase() === 'OK';
      const telOkByFields = hasVal(finalD.tel_codigo) && hasVal(finalD.tel_numero);
      if (!(telOkByFields || telEstadoOk)) {
        miss.push('Falta tel√©fono (c√≥digo y n√∫mero)');
      }

      return { miss, warns };
    }

    // ----------------- flujo principal -----------------
    async function callWorkflow(){
      // Pod√©s modificar el body si tu webhook espera otro formato
      const resp = await fetch(WORKFLOW_URL, {
        method: 'GET'
      });

      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      // Puede venir vac√≠o ‚Üí evitamos ‚ÄúUnexpected end of JSON input‚Äù
      const text = await resp.text();
      if (!text || !text.trim()) {
        throw new Error('El servidor respondi√≥ JSON vac√≠o');
      }

      let data = null;
      try{
        data = JSON.parse(text);
      }catch(e){
        // Si el endpoint devuelve un √∫nico objeto, permitimos eso tambi√©n
        try{
          data = JSON.parse(text.replace(/^\s*\[?/, '[').replace(/\]?\s*$/, ']'));
        }catch(e2){
          throw new Error('Respuesta no es JSON v√°lido');
        }
      }

      if (!Array.isArray(data) || data.length === 0) {
        throw new Error('Respuesta sin items');
      }

      // Usamos el primer item
      const d = data[0];

      // Guardamos y renderizamos ‚Äútal cual‚Äù para debug
      out.textContent = JSON.stringify(d, null, 2);

      // Previsualizamos
      renderPreview(d);

      // Preparamos payload final (whitelist + normalizaci√≥n)
      const finalD = toFinalPayload(d);

      // Validaciones y avisos
      const { miss, warns } = getMissing(finalD);
      renderAlerts(miss, warns, { telefono_estado: finalD.telefono_estado, telefono_msg: finalD.telefono_msg });

      // Persistimos el JSON final en el DOM (para el bot√≥n Confirmar/Copiar)
      out.dataset.final = JSON.stringify(finalD);
    }

    function copyJSON(){
      const text = out.dataset.final || out.textContent || '{}';
      navigator.clipboard.writeText(text).then(()=>{
        alert('JSON copiado al portapapeles');
      });
    }

    async function confirmar(){
      // Ac√° enviar√≠as el payload final a tu endpoint de ‚Äúagregar a hoja‚Äù
      const finalText = out.dataset.final;
      if (!finalText){
        alert('Primero proces√° con IA para generar el payload.');
        return;
      }
      const payload = JSON.parse(finalText);

      // Ejemplo: POST a /agregar
      // const r = await fetch(ENDPOINT_AGREGAR, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });

      alert('Listo para enviar a la hoja.\n\n' + JSON.stringify(payload, null, 2));
    }

    // ----------------- eventos -----------------
    $('btnAI').addEventListener('click', async () => {
      $('btnAI').disabled = true;
      try{
        await callWorkflow();
      }catch(e){
        alerts.innerHTML = '';
        const s = document.createElement('span');
        s.className = 'chip bad';
        s.textContent = 'REVISAR: ' + e.message;
        alerts.appendChild(s);
      }finally{
        $('btnAI').disabled = false;
      }
    });

    $('btnCopy').addEventListener('click', copyJSON);
    $('btnConfirm').addEventListener('click', confirmar);

    // Render inicial m√≠nimo (placeholders)
    renderPreview({
      peso_grs: 1000, alto_cm: 10, ancho_cm: 10, valor_declarado: 50000
    });
    renderAlerts([], ['Altura no provista (se usa 0)']); // ejemplo visual
  </script>
</body>
</html>
