<!-- index.html (frontend estático con pantalla inicial y módulo "Gestión de Ventas y Envíos FULL") -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ML Dashboard Lite</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; background:#0b0d10; color:#e7ecef; }
    header { padding:16px 20px; border-bottom:1px solid #22262b; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    header h1 { font-size:18px; margin:0; font-weight:700; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:12px; color:#aeb6bf; }
    .field input { padding:8px 10px; border-radius:10px; border:1px solid #2a3036; background:#111418; color:#e7ecef; min-width:260px; }
    .btn { padding:10px 14px; border-radius:12px; border:1px solid #2a3036; background:#161a20; color:#e7ecef; cursor:pointer; font-weight:600; }
    .btn:hover { background:#1a1f26; }
    .btn.primary { background:#1e293b; border-color:#334155; }
    .btn.primary:hover { background:#243142; }
    .muted { color:#aeb6bf; font-size:12px; }
    main { padding:20px; }
    .view { display:none; }
    .view.active { display:block; }
    .grid { display:grid; gap:14px; }
    .menu-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .tile { background:#101318; border:1px solid #21262d; border-radius:16px; padding:16px; display:flex; flex-direction:column; gap:8px; }
    .tile h3 { margin:0; font-size:16px; }
    .tile p { margin:0; color:#aeb6bf; font-size:13px; }
    .card { background:#101318; border:1px solid #21262d; border-radius:16px; padding:16px; }
    .rowgap { gap:10px; }
    .table { width:100%; border-collapse: collapse; font-size:14px; }
    .table th, .table td { border-bottom:1px solid #20242a; padding:8px; text-align:left; }
    .topbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#16202a; border:1px solid #2a3440; font-size:12px; color:#aeb6bf; }
    .config { padding:12px 16px; border-top:1px solid #22262b; display:none; }
    .config.show { display:block; }
  </style>
</head>
<body>
  <header>
    <h1>ML Dashboard Lite</h1>
    <div class="row">
      <span class="badge" id="jsStatus">JS: cargando…</span>
      <button class="btn" id="btnTestJs">Test JS</button>
      <button class="btn" id="btnHome">Inicio</button>
      <button class="btn" id="btnConfig">Config</button>
    </div>
  </header>
  <!-- Debug: si este script corre, el DOM y JS básico están bien -->
  <script>
// Fallback global: mostrar errores JS en el badge
window.onerror = function(msg, src, line, col, err){
  try{var b=document.getElementById('jsStatus'); if(b) b.textContent='JS ERROR: '+msg;}catch(e){}
}

// Versión ES5 (sin arrow, sin let/const, sin template strings, sin optional chaining)
document.addEventListener('DOMContentLoaded', function(){
  try {
    // Helpers de DOM
    function el(id){ return document.getElementById(id) }

    // Config localStorage
    var cfg = {
      get base(){ return localStorage.getItem('api_base') || '' },
      set base(v){ localStorage.setItem('api_base', v) },
      get token(){ return localStorage.getItem('api_token') || '' },
      set token(v){ localStorage.setItem('api_token', v) }
    }
    function loadCfgIntoUI(){ var b=el('apiBase'), t=el('apiToken'); if(b) b.value = cfg.base; if(t) t.value = cfg.token }
    function saveCfgFromUI(){ var b=el('apiBase'), t=el('apiToken'); if(b) cfg.base = (b.value||'').trim(); if(t) cfg.token = (t.value||'').trim() }

    // HTTP simple con Bearer
    function apiGet(path){
      return new Promise(function(resolve, reject){
        if(!cfg.base) return reject(new Error('Falta API Base URL'))
        var url = cfg.base.replace(/\/$/, '') + path
        var opts = { headers: {} }
        if (cfg.token) opts.headers['Authorization'] = 'Bearer ' + cfg.token
        fetch(url, opts).then(function(res){
          if(!res.ok){
            res.text().then(function(t){
              var detail = ''
              try{ var j = JSON.parse(t); detail = j.detail || j.error || t }catch(_){ detail = t }
              reject(new Error(res.status + ' ' + res.statusText + (detail? ' - ' + detail : '')))
            }).catch(function(){ reject(new Error(res.status + ' ' + res.statusText)) })
            return
          }
          res.json().then(resolve).catch(function(e){ reject(new Error('JSON parse: ' + e.message)) })
        }).catch(function(e){ reject(e) })
      })
    }

    // Router simple
    function showView(id){
      var nodes = document.querySelectorAll('.view');
      for(var i=0;i<nodes.length;i++){ nodes[i].classList.remove('active') }
      var v = el(id); if(v) v.classList.add('active')
      location.hash = id
    }
    window.addEventListener('hashchange', function(){
      var id = location.hash.replace('#','')
      if (id && document.getElementById(id)) showView(id)
    })

    // CSV utils (compatibles)
    function toCsv(headers, rows){
      function esc(v){ return String(v==null?'':v).replace(/\"/g, '""') }
      function line(r){
        var out = []
        for(var i=0;i<r.length;i++){ out.push('"' + esc(r[i]) + '"') }
        return out.join(',')
      }
      var lines = [headers.join(',')]
      for(var i=0;i<rows.length;i++){ lines.push(line(rows[i])) }
      return lines.join('
')
    }

    // Tests básicos CSV
    function runTests(){
      function ok(name, cond){ console.log('[test]', name, cond?'OK':'FAIL') }
      var csv1 = toCsv(['a','b'], [[1,2],[3,4]])
      ok('lineas', csv1.split('
').length===3)
      var csv2 = toCsv(['x'], [["a,b"]]); ok('coma', csv2.indexOf('"a,b"')>=0)
      var csv3 = toCsv(['x'], [["a\"b"]]); ok('comillas', csv3.indexOf('"a""b"')>=0)
      var csv4 = toCsv(['x','y'], []); ok('solo header', csv4==='x,y')
      var badge = el('testsBadge'); if (badge) badge.textContent = 'Tests: OK'
    }

    // Utils de mapeo de campos
    function pick(obj, keys, fallback){
      if (fallback===undefined) fallback=''
      for(var i=0;i<keys.length;i++){ var k=keys[i]; if(obj && obj[k]!==undefined && obj[k]!==null) return obj[k] }
      return fallback
    }
    function fmtDate(v){
      var s = String(v==null?'':v)
      if(!s) return ''
      return s.indexOf('T')>=0 ? s.slice(0,10) : s
    }

    // Gestión FULL
    var fullRows = []
    function setDefaultDates(){ var d=el('dateFull'); if(d){ var to = new Date(); d.value = to.toISOString().slice(0,10) } }
    function renderFullTable(rows){
      var tb = document.querySelector('#fullTable tbody'); if(!tb) return
      tb.innerHTML = ''
      for(var i=0;i<Math.min(rows.length,1000);i++){
        var r = rows[i]
        var itemId = pick(r, ['item_id','itemId','ml_item_id','ml_id'])
        var title  = pick(r, ['title','item_title','name'])
        var invId  = pick(r, ['inventory_id','inventoryId'])
        var qty    = pick(r, ['available_quantity','qty','quantity','available_qty','available'])
        var date   = fmtDate(pick(r, ['date','created_at','updated_at']))
        var tr = document.createElement('tr')
        tr.innerHTML = '<td>'+itemId+'</td><td>'+title+'</td><td>'+invId+'</td><td>'+qty+'</td><td>'+date+'</td>'
        tb.appendChild(tr)
      }
      var meta = el('fullMeta'); if(meta) meta.textContent = 'Filas: ' + rows.length
    }
    function loadFull(){
      try {
        var d = el('dateFull'); var date = d? d.value : ''
        apiGet('/stock/full?date='+encodeURIComponent(date)).then(function(data){
          fullRows = data.rows || []
          renderFullTable(fullRows)
        }).catch(function(e){ alert('Error stock Full: ' + e.message) })
      } catch(e){ alert('Error stock Full: ' + e.message) }
    }
    function applyFullFilter(){
      var inp = el('filterFull'); var q = (inp?inp.value:'').trim().toLowerCase()
      if (!q) return renderFullTable(fullRows)
      var f = []
      for(var i=0;i<fullRows.length;i++){
        var r = fullRows[i]
        var id = String(pick(r,['item_id','itemId','ml_item_id','ml_id'],'')).toLowerCase()
        var ti = String(pick(r,['title','item_title','name'],'')).toLowerCase()
        if (id.indexOf(q)>=0 || ti.indexOf(q)>=0) f.push(r)
      }
      renderFullTable(f)
    }
    function exportCsv(){
      var headers = ['item_id','title','inventory_id','qty','date']
      var body = document.querySelector('#fullTable tbody')
      var rows = []
      if (body){
        var trs = body.querySelectorAll('tr')
        for(var i=0;i<trs.length;i++){
          var tds = trs[i].children
          var row = []
          for(var j=0;j<tds.length;j++){ row.push(tds[j].textContent || '') }
          rows.push(row)
        }
      }
      var csv = toCsv(headers, rows)
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
      var url = URL.createObjectURL(blob)
      var a = document.createElement('a'); a.href = url; a.download = 'full_stock_'+((el('dateFull') && el('dateFull').value) || 'snapshot')+'.csv'; a.click()
      URL.revokeObjectURL(url)
    }

    // Bind seguro de eventos
    function bind(id, fn){ var node = el(id); if(node) node.onclick = function(){ try{ fn() }catch(e){ alert('Error '+id+': '+e.message) } }; }
    bind('btnHome', function(){ showView('view-home') })
    bind('btnConfig', function(){ var p=document.getElementById('configPanel'); if(p) p.classList.toggle('show') })
    bind('saveCfg', function(){ saveCfgFromUI(); alert('Guardado') })
    bind('goGestionFull', function(){ showView('view-gestion-full') })
    bind('backHome', function(){ showView('view-home') })
    bind('loadFull', loadFull)
    var f = el('filterFull'); if (f) f.oninput = applyFullFilter
    bind('exportCsv', exportCsv)

    // Init
    loadCfgIntoUI(); setDefaultDates(); runTests();
    var s = document.getElementById('jsStatus'); if(s) s.textContent='JS: OK'
    var t = document.getElementById('btnTestJs'); if(t) t.onclick=function(){ alert('JS funciona') }
    console.log('[init] UI lista')

  } catch (e) {
    console.error('[fatal] init error', e)
    var s2=document.getElementById('jsStatus'); if(s2) s2.textContent='JS ERROR: '+(e.message||e)
    alert('Error inicializando la app: ' + (e && e.message ? e.message : e))
  }
})
</script>
</body>
</html>
