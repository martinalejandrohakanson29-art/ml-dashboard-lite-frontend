<!-- index.html (frontend estático con pantalla inicial y módulo "Gestión de Ventas y Envíos FULL") -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ML Dashboard Lite</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; background:#0b0d10; color:#e7ecef; }
    header { padding:16px 20px; border-bottom:1px solid #22262b; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    header h1 { font-size:18px; margin:0; font-weight:700; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:12px; color:#aeb6bf; }
    .field input { padding:8px 10px; border-radius:10px; border:1px solid #2a3036; background:#111418; color:#e7ecef; min-width:260px; }
    .btn { padding:10px 14px; border-radius:12px; border:1px solid #2a3036; background:#161a20; color:#e7ecef; cursor:pointer; font-weight:600; }
    .btn:hover { background:#1a1f26; }
    .btn.primary { background:#1e293b; border-color:#334155; }
    .btn.primary:hover { background:#243142; }
    .muted { color:#aeb6bf; font-size:12px; }
    main { padding:20px; }
    .view { display:none; }
    .view.active { display:block; }
    .grid { display:grid; gap:14px; }
    .menu-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .tile { background:#101318; border:1px solid #21262d; border-radius:16px; padding:16px; display:flex; flex-direction:column; gap:8px; }
    .tile h3 { margin:0; font-size:16px; }
    .tile p { margin:0; color:#aeb6bf; font-size:13px; }
    .card { background:#101318; border:1px solid #21262d; border-radius:16px; padding:16px; }
    .rowgap { gap:10px; }
    .table { width:100%; border-collapse: collapse; font-size:14px; }
    .table th, .table td { border-bottom:1px solid #20242a; padding:8px; text-align:left; }
    .topbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#16202a; border:1px solid #2a3440; font-size:12px; color:#aeb6bf; }
    .config { padding:12px 16px; border-top:1px solid #22262b; display:none; }
    .config.show { display:block; }

.dot { display:inline-block; width:10px; height:10px; border-radius:50%; }
.dot.ok { background:#22c55e; }
.dot.warn { background:#eab308; }
.dot.risk { background:#ef4444; }
.dot.near { background:#f97316; }

    
  </style>
</head>
<body>
  <header>
    <h1>ML Dashboard Lite</h1>
    <div class="row">
      <span class="badge" id="jsStatus">JS: cargando…</span>
      <button class="btn" id="btnTestJs">Test JS</button>
      <button class="btn" id="btnHome">Inicio</button>
      <button class="btn" id="btnConfig">Config</button>
    </div>
  </header>

  <main>
    <!-- PANEL DE CONFIG -->
    <section id="configPanel" class="config">
      <div class="row rowgap">
        <div class="field">
          <label for="apiBase">API Base URL</label>
          <input id="apiBase" placeholder="https://tu-back.onrender.com" />
        </div>
        <div class="field">
          <label for="apiToken">API Token (Bearer)</label>
          <input id="apiToken" placeholder="APP_USR-..." />
        </div>
        <button class="btn primary" id="saveCfg">Guardar</button>
        <span class="badge" id="testsBadge">Tests: …</span>
      </div>
    </section>

    <!-- INICIO -->
   <section id="view-home" class="view active">
  <div class="grid menu-grid">
    <div class="tile">
      <h3>Full – Decisiones</h3>
      <p>Stock + conversión + semáforos.</p>
      <div class="row">
        <button class="btn primary" id="goFullDecisions">Abrir</button>
      </div>
    </div>
  </div>
</section>


    <!-- GESTIÓN FULL -->
    <section id="view-gestion-full" class="view">
      <div class="card" style="margin-bottom:14px;">
       <div class="topbar">
  <button class="btn" id="backHome">← Volver</button>
  <div class="field" style="min-width:280px;">
    <label for="filterFull">Filtro (item_id, título o inventory_id)</label>
    <input id="filterFull" placeholder="MLA..., texto..., INV..." />
  </div>
  <button class="btn primary" id="loadFull">Cargar</button>
  <span class="badge" id="fullMeta">Filas: 0</span>
</div>
      </div>

      <div class="card">
        <div style="overflow:auto;">
          <table id="fullTable" class="table">
            <thead>
              <tr>
                <th>item_id</th>
                <th>title</th>
                <th>inventory_id</th>
               <th>stock</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>



  <!-- FULL – DECISIONES -->
<section id="view-full-decisions" class="view">
<div class="card" style="margin-bottom:14px;">
<div class="topbar">
<button class="btn" id="backHome2">← Volver</button>
<div class="field" style="min-width:140px;">
<label for="decWindow">Ventana (días)</label>
<select id="decWindow">
<option value="30" selected>30</option>
<option value="60">60</option>
</select>
</div>
<div class="field" style="min-width:140px;">
<label for="decLeadTime">Lead time (días)</label>
<input id="decLeadTime" type="number" min="1" value="7" />
</div>
<button class="btn primary" id="loadDecisions">Cargar</button>
<span class="badge" id="decMeta">Filas: 0</span>
</div>
</div>


<div class="card">
<div style="overflow:auto;">
<table class="table" id="decTable">
<thead>
<tr>
<th data-k="overall_flag">⚑</th>
<th data-k="item_id">Item</th>
<th data-k="title">Título</th>
<th data-k="stock_full">Stock</th>
<th data-k="ventas_nd">Ventas</th>
<th data-k="visitas_nd">Visitas</th>
<th data-k="conv_nd">%Conv</th>
<th data-k="demanda_diaria">Demanda/día</th>
<th data-k="days_coverage">Cobertura (días)</th>
<th data-k="break_date">Quiebre</th>
<th data-k="stock_flag">Semáforo Stock</th>
<th data-k="storage_flag">Semáforo Almacén</th>
<th data-k="suggested_send">Sugerido</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</section>


  
  <!-- JS -->
  <script>
  // Fallback global: mostrar errores JS en el badge
  window.onerror = function(msg, src, line, col, err){
    try{var b=document.getElementById('jsStatus'); if(b) b.textContent='JS ERROR: '+msg;}catch(e){}
  }

  // Versión ES5 (sin arrow, sin let/const, sin template strings, sin optional chaining)
  document.addEventListener('DOMContentLoaded', function(){
    try {
      // Helpers de DOM
      function el(id){ return document.getElementById(id) }

      // Config localStorage
      var cfg = {
        get base(){ return localStorage.getItem('api_base') || '' },
        set base(v){ localStorage.setItem('api_base', v) },
        get token(){ return localStorage.getItem('api_token') || '' },
        set token(v){ localStorage.setItem('api_token', v) }
      }
      function loadCfgIntoUI(){ var b=el('apiBase'), t=el('apiToken'); if(b) b.value = cfg.base; if(t) t.value = cfg.token }
      function saveCfgFromUI(){ var b=el('apiBase'), t=el('apiToken'); if(b) cfg.base = (b.value||'').trim(); if(t) cfg.token = (t.value||'').trim() }

      // HTTP simple con Bearer
      function apiGet(path){
        return new Promise(function(resolve, reject){
          if(!cfg.base) return reject(new Error('Falta API Base URL'))
          var url = cfg.base.replace(/\/$/, '') + path
          var opts = { headers: {} }
          if (cfg.token) opts.headers['Authorization'] = 'Bearer ' + cfg.token
          fetch(url, opts).then(function(res){
            if(!res.ok){
              res.text().then(function(t){
                var detail = ''
                try{ var j = JSON.parse(t); detail = j.detail || j.error || t }catch(_){ detail = t }
                reject(new Error(res.status + ' ' + res.statusText + (detail? ' - ' + detail : '')))
              }).catch(function(){ reject(new Error(res.status + ' ' + res.statusText)) })
              return
            }
            res.json().then(resolve).catch(function(e){ reject(new Error('JSON parse: ' + e.message)) })
          }).catch(function(e){ reject(e) })
        })
      }

      // Router simple
      function showView(id){
        var nodes = document.querySelectorAll('.view');
        for(var i=0;i<nodes.length;i++){ nodes[i].classList.remove('active') }
        var v = el(id); if(v) v.classList.add('active')
        location.hash = id
      }
      window.addEventListener('hashchange', function(){
        var id = location.hash.replace('#','')
        if (id && document.getElementById(id)) showView(id)
      })

      // CSV utils (compatibles)
      function toCsv(headers, rows){
        function esc(v){ return String(v==null?'':v).replace(/\"/g, '""') }
        function line(r){
          var out = []
          for(var i=0;i<r.length;i++){ out.push('"' + esc(r[i]) + '"') }
          return out.join(',')
        }
        var lines = [headers.join(',')]
        for(var i=0;i<rows.length;i++){ lines.push(line(rows[i])) }
        return lines.join('\n')
      }

      // Tests básicos CSV
      function runTests(){
        function ok(name, cond){ console.log('[test]', name, cond?'OK':'FAIL') }
        var csv1 = toCsv(['a','b'], [[1,2],[3,4]])
        ok('lineas', csv1.split('\n').length===3)
        var csv2 = toCsv(['x'], [["a,b"]]); ok('coma', csv2.indexOf('"a,b"')>=0)
        var csv3 = toCsv(['x'], [["a\"b"]]); ok('comillas', csv3.indexOf('"a""b"')>=0)
        var csv4 = toCsv(['x','y'], []); ok('solo header', csv4==='x,y')
        var badge = el('testsBadge'); if (badge) badge.textContent = 'Tests: OK'
      }

      // Utils de mapeo de campos
      function pick(obj, keys, fallback){
        if (fallback===undefined) fallback=''
        for(var i=0;i<keys.length;i++){ var k=keys[i]; if(obj && obj[k]!==undefined && obj[k]!==null) return obj[k] }
        return fallback
      }
      function fmtDate(v){
        var s = String(v==null?'':v)
        if(!s) return ''
        return s.indexOf('T')>=0 ? s.slice(0,10) : s
      }

      // Gestión FULL
      var fullRows = []
      function setDefaultDates(){ var d=el('dateFull'); if(d){ var to = new Date(); d.value = to.toISOString().slice(0,10) } }
   function renderFullTable(rows){
  var tb = document.querySelector('#fullTable tbody'); if(!tb) return
  tb.innerHTML = ''
  for(var i=0;i<Math.min(rows.length,1000);i++){
    var r = rows[i]
    var itemId = pick(r, ['item_id','itemId','ml_item_id','ml_id'])
    var title  = pick(r, ['title','item_title','name'])
    var invId  = pick(r, ['inventory_id','inventoryId'])

    var tr = document.createElement('tr')
    tr.innerHTML =
      '<td>'+itemId+'</td>'+
      '<td>'+title+'</td>'+
      '<td>'+invId+'</td>'+
      // 👇 usar el campo normalizado 'stock' (numérico)
      '<td>'+Number(r.stock||0)+'</td>'
    tb.appendChild(tr)
  }
  var meta = el('fullMeta'); if(meta) meta.textContent = 'Filas: ' + rows.length
}


 function loadFull(){
  try {
    apiGet('/stock/full').then(function(data){
    // Normalizamos claves/formatos para que el filtro funcione bien
fullRows = (data.rows || []).map(function(r){
  return {
    inventory_id: String(pick(r, ['inventory_id','inventoryId'], '')),
    item_id: String(pick(r, ['item_id','itemId','ml_item_id','ml_id'], '')).trim().toUpperCase(),
    title:        String(pick(r, ['title','item_title','name'], '')),

    // 👇 clave: usar 'stock' y castear a número. Priorizar 'total'.
    stock: Number(pick(r, ['total','available_quantity','available','qty','stock'], 0)) || 0,
  }
})

renderFullTable(fullRows)

    }).catch(function(e){ alert('Error stock Full: ' + e.message) })
  } catch(e){ alert('Error stock Full: ' + e.message) }
}



  function applyFullFilter(){
  var inp = el('filterFull'); 
  var raw = (inp ? inp.value : '').trim().toLowerCase();
  if (!raw) return renderFullTable(fullRows);

  var tokens = raw.split(/\s+/); // varias palabras separadas por espacio
  var f = [];
  for (var i = 0; i < fullRows.length; i++) {
    var r = fullRows[i];

    // Armamos un texto unificado con item_id, title e inventory_id
    var haystack =
      (r.item_id || '').toLowerCase() + ' ' +
      (r.title   || '').toLowerCase() + ' ' +
      (r.inventory_id || '').toLowerCase();

    // Todas las palabras tienen que aparecer
    var ok = true;
    for (var t = 0; t < tokens.length; t++) {
      if (haystack.indexOf(tokens[t]) < 0) { ok = false; break; }
    }
    if (ok) f.push(r);
  }
  renderFullTable(f);
}




// ===== Full – Decisiones (frontend) =====
var decRows = [];
var decSortKey = 'overall_flag';
var decSortDir = 'asc';

function colorDot(flag){
  var cls = 'ok';
  if (flag === 'risk') cls = 'risk';
  else if (flag === 'warn') cls = 'warn';
  else if (flag === 'near') cls = 'near';
  return '<span class="dot '+cls+'" title="'+(flag||'ok')+'"></span>';
}

function renderDecisions(rows){
  var tb = document.querySelector('#decTable tbody'); if(!tb) return;
  tb.innerHTML = '';
  var arr = rows.slice();
  arr.sort(function(a,b){
    var k = decSortKey, dir = (decSortDir==='asc'?1:-1);
    var va = a[k], vb = b[k];
    if (va==null && vb==null) return 0;
    if (va==null) return 1*dir;
    if (vb==null) return -1*dir;
    if (typeof va === 'string' && typeof vb === 'string') return va.localeCompare(vb)*dir;
    va = Number(va); vb = Number(vb);
    if (!isFinite(va) || !isFinite(vb)) return String(a[k]).localeCompare(String(b[k]))*dir;
    return (va>vb?1:va<vb?-1:0)*dir;
  });

  for (var i=0; i<Math.min(arr.length, 1000); i++){
    var r = arr[i];
    var convPct = Math.round(((r.conv_nd||0)*100)*100)/100; // 2 decimales
    var cov = (r.days_coverage!=null) ? (Math.round(r.days_coverage*10)/10) : '∞';
    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td>'+colorDot(r.overall_flag||r.stock_flag)+'</td>'+
      '<td>'+String(r.item_id||'')+'</td>'+
      '<td>'+String(r.title||'')+'</td>'+
      '<td>'+Number(r.stock_full||0)+'</td>'+
      '<td>'+Number(r.ventas_nd||0)+'</td>'+
      '<td>'+Number(r.visitas_nd||0)+'</td>'+
      '<td>'+convPct+'%'+ '</td>'+
      '<td>'+ (r.demanda_diaria? (Math.round(r.demanda_diaria*100)/100) : '0') +'</td>'+
      '<td>'+ cov +'</td>'+
      '<td>'+ (r.break_date||'') +'</td>'+
      '<td>'+colorDot(r.stock_flag)+'</td>'+
      '<td>'+colorDot(r.storage_flag)+'</td>'+
      '<td>'+Number(r.suggested_send||0)+'</td>';
    tb.appendChild(tr);
  }
  var meta = document.getElementById('decMeta'); if(meta) meta.textContent = 'Filas: ' + rows.length;
}

function loadDecisions(){
  var wEl = document.getElementById('decWindow');
  var lEl = document.getElementById('decLeadTime');
  var w   = wEl? Number(wEl.value||30) : 30;
  var lt  = lEl? Number(lEl.value||7) : 7;
  apiGet('/full/decisions?window='+w+'&lead_time='+lt)
    .then(function(data){ decRows = (data.items||[]); renderDecisions(decRows); })
    .catch(function(e){ alert('Error decisiones: ' + (e && e.message ? e.message : e)); });
}

// Sorting por click en encabezado
(function setupDecSort(){
  var thead = document.querySelector('#decTable thead');
  if (!thead) return;
  thead.addEventListener('click', function(ev){
    var th = ev.target.closest('th'); if(!th) return;
    var k = th.getAttribute('data-k'); if(!k) return;
    if (decSortKey === k) decSortDir = (decSortDir==='asc' ? 'desc' : 'asc');
    else { decSortKey = k; decSortDir = 'asc'; }
    renderDecisions(decRows);
  });
})();


      


// Sorting por click en encabezado
(function setupDecSort(){
var thead = document.querySelector('#decTable thead');
if (!thead) return;
thead.addEventListener('click', function(ev){
var th = ev.target.closest('th'); if(!th) return;
var k = th.getAttribute('data-k'); if(!k) return;
if (decSortKey === k) decSortDir = (decSortDir==='asc' ? 'desc' : 'asc');
else { decSortKey = k; decSortDir = 'asc'; }
renderDecisions(decRows)
})
})();
      

      // Bind de eventos
      function bind(id, fn){ var node = el(id); if(node) node.onclick = function(){ try{ fn() }catch(e){ alert('Error '+id+': '+e.message) } }; }
      bind('btnHome', function(){ showView('view-home') })
bind('btnConfig', function(){
  var p=document.getElementById('configPanel'); if(p) p.classList.toggle('show')
})
bind('saveCfg', function(){ saveCfgFromUI(); alert('Guardado') })
bind('goGestionFull', function(){ showView('view-gestion-full') })
bind('backHome', function(){ showView('view-home') })
bind('loadFull', loadFull)
    bind('goFullDecisions', function(){ showView('view-full-decisions') })
bind('backHome2', function(){ showView('view-home') })
bind('loadDecisions', loadDecisions)

var f = el('filterFull'); if (f) f.oninput = applyFullFilter

// Init
loadCfgIntoUI(); runTests(); // <-- quitamos setDefaultDates()
var s = document.getElementById('jsStatus'); if(s) s.textContent='JS: OK'
var t = document.getElementById('btnTestJs'); if(t) t.onclick=function(){ alert('JS funciona') }


    } catch (e) {
      console.error('[fatal] init error', e)
      var s2=document.getElementById('jsStatus'); if(s2) s2.textContent='JS ERROR: '+(e.message||e)
      alert('Error inicializando la app: ' + (e && e.message ? e.message : e))
    }
  })
  </script>
</body>
</html>
